## 微前端
微前端架构是一种类似于微服务的架构，它将微服务的理念应用于浏览器端，即将 Web 应用由单一的单体应用转变为**多个小型前端应用聚合为一的应用**。

由此带来的变化是，这些前端应用可以**独立运行**、**独立开发**、**独立部署**。以及，它们应该可以在**共享组件**的同时进行并行开发——这些组件可以通过 NPM 或者 Git Tag、Git Submodule 来管理。

它主要解决了两个问题：

- 1、随着项目迭代应用越来越庞大，难以维护。
- 2、跨团队或跨部门协作开发项目导致效率低下的问题。

**注意**：这里的前端应用指的是前后端分离的单应用页面，在这基础才谈论微前端才有意义。

微前端架构一般可以由以下几种方式进行：

**1.使用 HTTP 服务器的路由来重定向多个应用**

通过 Nginx 服务器根据 url 路径动态设置要加载的模板

优点

- 实现简单
- 技术栈独立

缺点

- 需要额外配置 Nginx
- 前后端分离不彻底

**2.iFrame。使用 iFrame 及自定义消息传递机制**

优点

- 实现简单
- 天然具备隔离性

缺点

- 主页面和 iframe 共享最大允许的 HTTP 链接数。
- iframe 阻塞主页面加载。
- 浏览器的后退按钮无效

在所有微前端方案中，iframe是最稳定的、上手难度最低的，但它有一些无法解决的问题，例如性能低、通信复杂、双滚动条、弹窗无法全局覆盖，它的成长性不高，只适合简单的页面渲染。

**3.微前端框架 single-spa与qiankun**

在single-spa和qiankun中都是通过监听url change事件，在路由变化时匹配到渲染的子应用并进行渲染。这种基于路由监听渲染是single-spa最早实现的，作为出现最早、最有影响力的微前端框架，single-spa被很多框架和公司借鉴，也导致目前实现的微前端的方式大多是基于路由监听。

优点

- 纯前端解决方案
- 可以使用多种技术栈
- 完善的生态

缺点

- 上手成本高
- 需要改造现有应用
- 跨应用的联调变得复杂

**4.npm包**

将子应用封装成npm包，通过组件的方式引入，在性能和兼容性上是最优的方案，但却有一个致命的问题就是版本更新，每次版本发布需要通知接入方同步更新，管理非常困难。

**5.microApp**

**HTML Entry**：是指设置html作为资源入口，通过加载远程html，解析其DOM结构从而获取js、css等静态资源来实现微前端的渲染，这也是qiankun目前采用的渲染方案。

**WebComponent**：web原生组件，它有两个核心组成部分：CustomElement和ShadowDom。CustomElement用于创建自定义标签，ShadowDom用于创建阴影DOM，阴影DOM具有天然的样式隔离和元素隔离属性。由于WebComponent是原生组件，它可以在任何框架中使用，理论上是实现微前端最优的方案。但WebComponent有一个无法解决的问题 - ShadowDom的兼容性非常不好，一些前端框架在ShadowDom环境下无法正常运行，尤其是react框架。

**类WebComponent**：就是使用CustomElement结合自定义的ShadowDom实现WebComponent基本一致的功能。

元素隔离源于ShadowDom的概念，即ShadowDom中的元素可以和外部的元素重复但不会冲突，ShadowDom只能对自己内部的元素进行操作。

MicroApp模拟实现了类似的功能，我们拦截了底层原型链上元素的方法，保证子应用只能对自己内部的元素进行操作，每个子应用都有自己的元素作用域。

元素隔离可以有效的防止子应用对基座应用和其它子应用元素的误操作，常见的场景是多个应用的根元素都使用相同的id，元素隔离可以保证子应用的渲染框架能够正确找到自己的根元素。

js沙箱通过Proxy代理子应用的全局对象，防止应用之间全局变量的冲突，记录或清空子应用的全局副作用函数，也可以向子应用注入全局变量用于定制化处理。

样式隔离是指对子应用的link和style元素的css内容进行格式化处理，确保子应用的样式只作用域自身，无法影响外部。（css in js、 bem 、shadow dom）

MicroApp在数据通信中遇到的最大的问题是自定义元素无法支持设置对象类型属性，例如`<micro-app data={x: 1}></micro-app>` 会转换为 `<micro-app data='[object Object]'></micro-app>`，想要以组件化形式进行数据通信必须让元素支持对象属性。

为了解决这个问题，我们重写了`micro-app`元素原型链上属性设置的方法，在`micro-app`元素设置对象属性时将传递的值保存到数据中心，通过数据中心将值分发给子应用。

![image](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1271aabbbcf040fcb640b989d71cb634~tplv-k3u1fbpfcp-watermark.awebp)

